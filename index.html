<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nevolve — Hukuki Araştırma</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #FAFAFA;
            --card: #FFFFFF;
            --text: #1A1A1A;
            --text-secondary: #4A4A4A;
            --text-muted: #8A8A8A;
            --border: #E5E5E5;
            --border-dark: #D0D0D0;
            --accent: #1A1A1A;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .serif { font-family: 'Cormorant Garamond', Georgia, serif; }

        .app {
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header - Minimal */
        .header {
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: lowercase;
        }

        .header-actions { display: flex; gap: 12px; }

        .header-btn {
            padding: 10px 18px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .header-btn:hover { border-color: var(--text); color: var(--text); }
        .header-btn.primary { background: var(--text); color: white; border-color: var(--text); }
        .header-btn.primary:hover { opacity: 0.85; }

        /* Main Content */
        .main {
            flex: 1;
            padding: 48px 32px;
        }

        /* Welcome */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 55vh;
            text-align: center;
        }

        .welcome-title {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 42px;
            font-weight: 400;
            letter-spacing: -0.5px;
            margin-bottom: 12px;
        }

        .welcome-desc {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 48px;
        }

        .quick-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            max-width: 600px;
            width: 100%;
        }

        .quick-item {
            padding: 20px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            color: var(--text);
        }

        .quick-item:hover { border-color: var(--text); }
        .quick-item-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }

        /* Conversation */
        .conversation { display: none; }
        .conversation.visible { display: block; }

        /* User Question */
        .question {
            padding: 24px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 32px;
        }

        .question-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .question-text {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 24px;
            font-weight: 400;
            line-height: 1.4;
            color: var(--text);
        }

        /* Response Document */
        .document {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 24px;
        }

        .doc-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .doc-meta { }
        .doc-title {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .doc-subtitle { font-size: 12px; color: var(--text-muted); }

        .doc-date { font-size: 12px; color: var(--text-muted); text-align: right; }

        .doc-body { padding: 32px; }

        /* Document Sections */
        .doc-section { margin-bottom: 32px; }
        .doc-section:last-child { margin-bottom: 0; }

        .doc-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .summary-item { }
        .summary-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .summary-value { font-size: 16px; font-weight: 600; color: var(--text); }

        /* Action List */
        .action-list { }

        .action-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .action-item:last-child { border-bottom: none; }

        .action-num {
            width: 28px;
            height: 28px;
            background: var(--text);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .action-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            padding-top: 4px;
        }

        /* Precedent Card */
        .precedent {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 20px 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .precedent:hover { border-color: var(--text); }

        .precedent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .precedent-court {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
        }

        .precedent-arrow { color: var(--text-muted); font-size: 14px; }

        .precedent-text {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-size: 17px;
            font-style: italic;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        /* Warning */
        .warning {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px 20px;
            background: #FFFBEB;
            border: 1px solid #FDE68A;
            border-radius: 4px;
        }

        .warning-icon { font-size: 16px; flex-shrink: 0; }
        .warning-text { font-size: 14px; line-height: 1.5; color: #92400E; }

        /* Sources Footer */
        .doc-footer {
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .sources-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .source-tag {
            padding: 8px 14px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .source-tag:hover { border-color: var(--text); color: var(--text); }

        .doc-actions {
            display: flex;
            gap: 12px;
        }

        .doc-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .doc-action-btn:hover { border-color: var(--text); color: var(--text); }

        /* Input Area */
        .input-area {
            padding: 24px 32px;
            background: var(--card);
            border-top: 1px solid var(--border);
        }

        .input-box {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 16px 20px;
            transition: border-color 0.2s;
        }

        .input-box:focus-within { border-color: var(--text); }

        #input {
            flex: 1;
            border: none;
            background: none;
            font-family: inherit;
            font-size: 15px;
            line-height: 1.5;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            color: var(--text);
        }

        #input:focus { outline: none; }
        #input::placeholder { color: var(--text-muted); }

        .send-btn {
            width: 40px;
            height: 40px;
            background: var(--text);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: opacity 0.2s;
        }

        .send-btn:hover { opacity: 0.85; }
        .send-btn:disabled { opacity: 0.3; }
        .send-btn svg { width: 18px; height: 18px; }

        /* Side Panel */
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .overlay.visible { opacity: 1; visibility: visible; }

        .panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100vh;
            background: var(--card);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .panel.open { right: 0; }

        .panel-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .panel-type { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; }
        .panel-title { font-family: 'Cormorant Garamond', Georgia, serif; font-size: 20px; font-weight: 600; }

        .panel-close {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-close:hover { border-color: var(--text); color: var(--text); }

        .panel-meta {
            padding: 20px 32px;
            background: var(--bg);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            font-size: 13px;
        }

        .meta-label { color: var(--text-muted); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .meta-value { font-weight: 600; color: var(--text); }

        .panel-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .panel-actions {
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .panel-btn {
            flex: 1;
            padding: 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .panel-btn:hover { border-color: var(--text); color: var(--text); }
        .panel-btn.primary { background: var(--text); color: white; border-color: var(--text); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 14px 24px;
            background: var(--text);
            color: white;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Loading */
        .loading {
            padding: 48px 32px;
            text-align: center;
        }

        .loading-text {
            font-size: 14px;
            color: var(--text-muted);
        }

        .loading-bar {
            width: 200px;
            height: 2px;
            background: var(--border);
            border-radius: 2px;
            margin: 24px auto 0;
            overflow: hidden;
        }

        .loading-bar::after {
            content: '';
            display: block;
            width: 40%;
            height: 100%;
            background: var(--text);
            animation: loading 1.2s ease-in-out infinite;
        }

        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(350%); }
        }

        /* Mobile */
        @media (max-width: 640px) {
            .header { padding: 16px 20px; }
            .logo { font-size: 20px; }
            .main { padding: 32px 20px; }
            .welcome-title { font-size: 32px; }
            .quick-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .doc-header, .doc-body, .doc-footer { padding: 20px; }
            .summary-grid { grid-template-columns: 1fr; gap: 16px; }
            .panel { width: 100%; right: -100%; }
            .input-area { padding: 16px 20px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">nevolve</div>
            <div class="header-actions">
                <button class="header-btn" onclick="newChat()">Yeni</button>
            </div>
        </header>

        <div class="main" id="main">
            <div class="welcome" id="welcome">
                <h1 class="welcome-title">Hukuki Araştırma Asistanı</h1>
                <p class="welcome-desc">Davanızı anlatın, emsal ve strateji oluşturalım.</p>
                <div class="quick-grid">
                    <button class="quick-item" data-q="Müvekkilim TCK 157 dolandırıcılık suçundan yargılanıyor. Savunma stratejisi ne olmalı?">
                        <div class="quick-item-label">Ceza</div>
                        Dolandırıcılık Savunması
                    </button>
                    <button class="quick-item" data-q="Borçlu icra takibine itiraz etti. 7 gün içinde ne yapmalıyım?">
                        <div class="quick-item-label">İcra</div>
                        İtirazın Kaldırılması
                    </button>
                    <button class="quick-item" data-q="İdari işleme karşı iptal davası açmak istiyorum. Süre ve prosedür nedir?">
                        <div class="quick-item-label">İdari</div>
                        İptal Davası
                    </button>
                    <button class="quick-item" data-q="Boşanma davasında mal paylaşımı ve nafaka hesaplama nasıl yapılır?">
                        <div class="quick-item-label">Aile</div>
                        Boşanma & Nafaka
                    </button>
                    <button class="quick-item" data-q="İşçi haksız yere işten çıkarıldı. İşe iade ve tazminat hakları neler?">
                        <div class="quick-item-label">İş</div>
                        İşe İade Davası
                    </button>
                    <button class="quick-item" data-q="Miras paylaşımında anlaşmazlık var. Saklı pay ve tenkis davası nedir?">
                        <div class="quick-item-label">Miras</div>
                        Saklı Pay & Tenkis
                    </button>
                </div>
            </div>

            <div class="conversation" id="conversation">
                <div class="question">
                    <div class="question-label">Soru</div>
                    <div class="question-text" id="questionText"></div>
                </div>

                <div class="document" id="document">
                    <div class="doc-header">
                        <div class="doc-meta">
                            <div class="doc-title" id="docTitle">Hukuki Analiz</div>
                            <div class="doc-subtitle" id="docSubtitle">Yargıtay İçtihadı</div>
                        </div>
                        <div class="doc-date" id="docDate"></div>
                    </div>

                    <div class="doc-body" id="docBody">
                        <!-- Content will be injected here -->
                    </div>

                    <div class="doc-footer">
                        <div class="sources-row" id="sourcesRow"></div>
                        <div class="doc-actions">
                            <button class="doc-action-btn" onclick="copyResponse()">
                                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <rect x="9" y="9" width="13" height="13" rx="2" stroke-width="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-width="2"/>
                                </svg>
                                Kopyala
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-box">
                <textarea id="input" rows="1" placeholder="Hukuki sorunuzu yazın..."></textarea>
                <button class="send-btn" id="sendBtn" onclick="send()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="panel" id="panel">
        <div class="panel-header">
            <div>
                <div class="panel-type" id="panelType">YARGITAY KARARI</div>
                <div class="panel-title" id="panelTitle">15. Ceza Dairesi</div>
            </div>
            <button class="panel-close" onclick="closePanel()">×</button>
        </div>
        <div class="panel-meta" id="panelMeta"></div>
        <div class="panel-content" id="panelContent"></div>
        <div class="panel-actions">
            <button class="panel-btn" onclick="copyPanel()">Kopyala</button>
            <button class="panel-btn primary" id="openSourceBtn" onclick="openSourceUrl()">Kaynağa Git →</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
        const $ = id => document.getElementById(id);
        let caseContents = [];
        let mevzuatData = [];
        let currentSourceUrl = null;

        $('input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        function toast(msg) {
            $('toast').textContent = msg;
            $('toast').classList.add('visible');
            setTimeout(() => $('toast').classList.remove('visible'), 2500);
        }

        function newChat() {
            $('welcome').style.display = 'flex';
            $('conversation').classList.remove('visible');
            $('input').value = '';
            caseContents = [];
            mevzuatData = [];
        }

        function formatDate() {
            const now = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return now.toLocaleDateString('tr-TR', options);
        }

        function parseResponse(text) {
            const sections = { ozet: {}, hemen: [], emsal: '', dikkat: [] };

            // Parse ÖZET
            const ozetMatch = text.match(/ÖZET[\s\S]*?(?=HEMEN|$)/i);
            if (ozetMatch) {
                const ozetText = ozetMatch[0];
                const konuMatch = ozetText.match(/Konu[^:]*:\s*([^\n•]+)/i);
                const sonucMatch = ozetText.match(/Sonuç[^:]*:\s*([^\n•]+)/i);
                const sureMatch = ozetText.match(/Süre[^:]*:\s*([^\n•]+)/i);

                sections.ozet = {
                    konu: konuMatch ? konuMatch[1].trim() : '',
                    sonuc: sonucMatch ? sonucMatch[1].trim() : '',
                    sure: sureMatch ? sureMatch[1].trim() : ''
                };
            }

            // Parse HEMEN YAP
            const hemenMatch = text.match(/HEMEN YAP[\s\S]*?(?=EMSAL|DİKKAT|$)/i);
            if (hemenMatch) {
                const items = hemenMatch[0].match(/\d+\.\s*[^\n]+/g) || [];
                sections.hemen = items.map(item => item.replace(/^\d+\.\s*/, '').trim()).filter(Boolean);
            }

            // Parse EMSAL
            const emsalMatch = text.match(/EMSAL[\s\S]*?(?=DİKKAT|KAYNAKLAR|$)/i);
            if (emsalMatch) {
                sections.emsal = emsalMatch[0].replace(/^EMSAL\s*\[\d+\]?\s*/i, '').replace(/\n/g, ' ').trim();
            }

            // Parse DİKKAT
            const dikkatMatch = text.match(/DİKKAT[\s\S]*$/i);
            if (dikkatMatch) {
                const items = dikkatMatch[0].match(/[•\-]\s*[^\n]+/g) || [];
                sections.dikkat = items.map(item => item.replace(/^[•\-]\s*/, '').trim()).filter(Boolean);
            }

            return sections;
        }

        function renderMarkdown(text) {
            if (!text) return '';
            return text
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/#{1,3}\s*/g, '')
                .replace(/\[\d+\]/g, '')
                .trim();
        }

        function renderDocument(sections) {
            let html = '';

            // ÖZET Section
            if (sections.ozet.konu || sections.ozet.sonuc || sections.ozet.sure) {
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">Özet</div>
                        <div class="summary-grid">
                            ${sections.ozet.konu ? `<div class="summary-item"><div class="summary-label">Konu</div><div class="summary-value">${renderMarkdown(sections.ozet.konu)}</div></div>` : ''}
                            ${sections.ozet.sonuc ? `<div class="summary-item"><div class="summary-label">Sonuç</div><div class="summary-value">${renderMarkdown(sections.ozet.sonuc)}</div></div>` : ''}
                            ${sections.ozet.sure ? `<div class="summary-item"><div class="summary-label">Süre</div><div class="summary-value">${renderMarkdown(sections.ozet.sure)}</div></div>` : ''}
                        </div>
                    </div>
                `;
            }

            // HEMEN YAP Section
            if (sections.hemen.length > 0) {
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">Eylem Planı</div>
                        <div class="action-list">
                            ${sections.hemen.map((item, i) => `
                                <div class="action-item">
                                    <div class="action-num">${i + 1}</div>
                                    <div class="action-text">${renderMarkdown(item)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // EMSAL Section
            if (sections.emsal) {
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">Emsal Karar</div>
                        <div class="precedent" onclick="openFirstSource()">
                            <div class="precedent-header">
                                <div class="precedent-court">${caseContents[0]?.daire || 'Yargıtay'}</div>
                                <div class="precedent-arrow">→</div>
                            </div>
                            <div class="precedent-text">"${renderMarkdown(sections.emsal)}"</div>
                        </div>
                    </div>
                `;
            }

            // DİKKAT Section
            if (sections.dikkat.length > 0) {
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">Önemli Uyarı</div>
                        ${sections.dikkat.map(item => `
                            <div class="warning">
                                <div class="warning-icon">⚠</div>
                                <div class="warning-text">${renderMarkdown(item)}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            return html;
        }

        function showLoading() {
            return `
                <div class="loading">
                    <div class="loading-text">Kaynaklar analiz ediliyor...</div>
                    <div class="loading-bar"></div>
                </div>
            `;
        }

        async function send() {
            const q = $('input').value.trim();
            if (!q) return;

            $('sendBtn').disabled = true;
            $('welcome').style.display = 'none';
            $('conversation').classList.add('visible');
            $('questionText').textContent = q;
            $('docBody').innerHTML = showLoading();
            $('sourcesRow').innerHTML = '';
            $('docDate').textContent = formatDate();
            $('input').value = '';
            $('input').style.height = 'auto';

            const ctx = await API.buildEnrichedContext(q);

            // Set document title based on case type
            if (ctx.caseType && ctx.caseType.type !== 'genel') {
                $('docTitle').textContent = ctx.caseType.label + ' Analizi';
                $('docSubtitle').textContent = ctx.caseType.type === 'idari' ? 'Danıştay İçtihadı' : 'Yargıtay İçtihadı';
            }

            let casesContext = '';
            let parsedKararlar = [];
            caseContents = [];

            // === YARGITAY KARARLARI ===
            if (ctx.yargitayKararlari.length > 0) {
                for (let i = 0; i < Math.min(2, ctx.yargitayKararlari.length); i++) {
                    const doc = await API.getDocument(ctx.yargitayKararlari[i].id);
                    if (doc.success) {
                        const parsed = API.parseKarar(doc.content, {
                            daire: ctx.yargitayKararlari[i].daire,
                            esasNo: ctx.yargitayKararlari[i].esasNo,
                            kararNo: ctx.yargitayKararlari[i].kararNo,
                            tarih: ctx.yargitayKararlari[i].tarih,
                            kaynak: 'yargitay'
                        });
                        if (parsed) {
                            parsed.content = doc.content;
                            parsedKararlar.push(parsed);
                            caseContents.push({ ...ctx.yargitayKararlari[i], content: doc.content, kaynak: 'yargitay', parsed });
                        }
                    }
                }
            }

            // === DANIŞTAY KARARLARI ===
            if (ctx.danistayKararlari.length > 0) {
                for (let i = 0; i < Math.min(2, ctx.danistayKararlari.length); i++) {
                    const doc = await API.getDanistayDocument(ctx.danistayKararlari[i].id);
                    if (doc.success) {
                        const parsed = API.parseKarar(doc.content, {
                            daire: ctx.danistayKararlari[i].daire || 'Danıştay',
                            esasNo: ctx.danistayKararlari[i].esasNo,
                            kararNo: ctx.danistayKararlari[i].kararNo,
                            tarih: ctx.danistayKararlari[i].tarih,
                            kaynak: 'danistay'
                        });
                        if (parsed) {
                            parsed.content = doc.content;
                            parsedKararlar.push(parsed);
                            caseContents.push({
                                ...ctx.danistayKararlari[i],
                                content: doc.content,
                                kaynak: 'danistay',
                                daire: ctx.danistayKararlari[i].daire || 'Danıştay',
                                parsed
                            });
                        }
                    }
                }
            }

            // Akıllı kaynak seçimi
            if (parsedKararlar.length > 2) {
                parsedKararlar = API.findBestMatch(q, parsedKararlar);
            }

            // Mevzuat
            if (ctx.mevzuatMaddeleri.length > 0) {
                mevzuatData = ctx.mevzuatMaddeleri;
            }

            // Yapılandırılmış context
            casesContext = API.buildStructuredContext(parsedKararlar, mevzuatData);

            let finalPrompt = q;
            if (ctx.caseType && ctx.caseType.type !== 'genel') {
                finalPrompt = `[${ctx.caseType.label} davası]\n\n${q}`;
            }
            finalPrompt += casesContext;

            const r = await API.askAI(finalPrompt);

            if (r.success) {
                const sections = parseResponse(r.text);
                $('docBody').innerHTML = renderDocument(sections);

                // Sources
                let srcHtml = '';
                caseContents.forEach((c, i) => {
                    const label = c.kaynak === 'danistay' ? 'Danıştay' : 'Yargıtay';
                    srcHtml += `<button class="source-tag" onclick="openPanel('karar', ${i})">${label} ${c.daire || ''}</button>`;
                });
                mevzuatData.forEach((m, i) => {
                    srcHtml += `<button class="source-tag" onclick="openPanel('mevzuat', ${i})">${m.kanunAdi || 'Kanun'} m.${m.madde}</button>`;
                });
                $('sourcesRow').innerHTML = srcHtml;

                toast('Analiz tamamlandı');
            } else {
                $('docBody').innerHTML = `<div class="warning"><div class="warning-icon">⚠</div><div class="warning-text">${r.error?.message || 'Bir hata oluştu'}</div></div>`;
            }

            $('sendBtn').disabled = false;
        }

        function openFirstSource() {
            if (caseContents.length > 0) openPanel('karar', 0);
        }

        function openPanel(type, index) {
            currentSourceUrl = null;

            if (type === 'karar') {
                const c = caseContents[index];
                const kaynakAdi = c.kaynak === 'danistay' ? 'DANIŞTAY KARARI' : 'YARGITAY KARARI';
                const kaynakKurum = c.kaynak === 'danistay' ? 'Danıştay' : 'Yargıtay';
                $('panelType').textContent = kaynakAdi;
                $('panelTitle').textContent = c.daire || kaynakKurum;
                $('panelMeta').innerHTML = `
                    <div><div class="meta-label">Esas No</div><div class="meta-value">${c.esasNo}</div></div>
                    <div><div class="meta-label">Karar No</div><div class="meta-value">${c.kararNo}</div></div>
                    <div><div class="meta-label">Tarih</div><div class="meta-value">${c.tarih}</div></div>
                    <div><div class="meta-label">Kaynak</div><div class="meta-value">${kaynakKurum}</div></div>
                `;
                $('panelContent').textContent = c.content;

                if (c.kaynak === 'danistay') {
                    currentSourceUrl = 'https://www.danistay.gov.tr/karar-arama';
                } else {
                    currentSourceUrl = 'https://karararama.yargitay.gov.tr/';
                }
            } else if (type === 'mevzuat') {
                const m = mevzuatData[index];
                const kanunAdi = m.kanunAdi || 'Kanun';
                const kanunNo = m.kanunKodu || m.kanun_no || '';
                $('panelType').textContent = 'KANUN MADDESİ';
                $('panelTitle').textContent = `${kanunAdi} Madde ${m.madde}`;
                $('panelMeta').innerHTML = `
                    <div><div class="meta-label">Kanun</div><div class="meta-value">${kanunAdi}</div></div>
                    <div><div class="meta-label">Kanun No</div><div class="meta-value">${kanunNo}</div></div>
                    <div><div class="meta-label">Madde</div><div class="meta-value">${m.madde}</div></div>
                    <div><div class="meta-label">Kaynak</div><div class="meta-value">mevzuat.gov.tr</div></div>
                `;
                $('panelContent').textContent = m.content || 'İçerik yüklenemedi';

                if (kanunNo) {
                    currentSourceUrl = `https://www.mevzuat.gov.tr/mevzuat?MevzuatNo=${kanunNo}&MevzuatTur=1&MevzuatTertip=5`;
                } else {
                    currentSourceUrl = 'https://www.mevzuat.gov.tr/';
                }
            }

            $('openSourceBtn').style.display = currentSourceUrl ? 'block' : 'none';
            $('panel').classList.add('open');
            $('overlay').classList.add('visible');
        }

        function openSourceUrl() {
            if (currentSourceUrl) {
                window.open(currentSourceUrl, '_blank');
            }
        }

        function closePanel() {
            $('panel').classList.remove('open');
            $('overlay').classList.remove('visible');
        }

        function copyPanel() {
            navigator.clipboard.writeText($('panelContent').textContent);
            toast('Kopyalandı');
        }

        function copyResponse() {
            const text = $('docBody').innerText;
            navigator.clipboard.writeText(text);
            toast('Yanıt kopyalandı');
        }

        $('overlay').onclick = closePanel;

        $('input').addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                send();
            }
        });

        document.querySelectorAll('.quick-item').forEach(btn => {
            btn.onclick = () => {
                $('input').value = btn.dataset.q;
                send();
            };
        });
    </script>
</body>
</html>
